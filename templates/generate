#!/usr/bin/bash


BROKERS="{{ brokers }}"
WORK_DIR="{{parts.buildout.directory}}/var/reports"
BIN_DIR="{{parts.buildout.directory}}/bin"


parse_date () {

    IFS='-' read -r year month day< <(echo "$1")
    if [ -z "$year" ] || [ -z "$month" ] || [ -z "$day" ]; then
        year=$(date +'%Y')
        if [ -z "$month" ] && [ -z "$day" ]; then
            month="$1"
            day="01"
        fi
        if ! [ -z "$month" ] && [ -z "$day" ]; then
            IFS='-' read -r month day< <(echo "$1")
        fi
    fi

    date -d"$year-$month-$day" +'%Y-%m-%d'
}



if [ -z "$1" ]; then
    START="$(date -d'-1 month' +'%Y-%m')-01"
else
    START="$(parse_date "$1")"
fi

if [ -z "$2" ]; then
    END="$(date  +'%Y-%m')-01"
else
    END="$(parse_date "$2")"
fi



echo "Generating reports form $START to $END"
echo

for broker in $BROKERS;do


    FILE_PATTERN="${WORK_DIR}/${broker}@$START--$END"
    for cmd in bids tenders invoices refunds; do
        echo "Generating ${cmd} for ${broker}"
        "${BIN_DIR}/${cmd}" -b "$broker" -p "$START" "$END"
    done


    passwd=$(pass "{{ zip_path }}/$broker")
    echo "Creating zip file with bids and invoices for ${broker}"
    find "$WORK_DIR"  -maxdepth 1 -regex "$FILE_PATTERN-\(invoices\|bids\|refunds\|tenders\).csv" | xargs -L 4 "${BIN_DIR}/zip" -p "$passwd" -z "$broker@$START--$END-bids-invoices.zip" -f 
    echo
done
echo

echo "Creating zip archive with invoices"
passwd=$(pass "{{zip_path}}/all")
find "$WORK_DIR" -maxdepth 1 -regex ".*@$START--$END-\(bids\|invoices\).csv" -exec cat "{}" \; | sort -ur > "all@$START_$END-bids-invoices.csv"
"${BIN_DIR}/zip" -p $passwd -z  "all@$START--$END-bids-invoices.zip" -f "all@$START_$END-bids-invoices.csv"
rm "all@$START_$END-bids-invoices.csv"
exit
echo



echo "Creating zip archive with refunds"
find "$WORK_DIR" -maxdepth 1 -regex ".*@$START--$END-\(tenders\|refunds\).csv" | xargs "${BIN_DIR}/zip" -z "all@$START--$END-tender-refunds.zip" -f
echo

echo "Sending to s3"
find "$WORK_DIR" -maxdepth 1 -name "*@$START--$END*.zip" -exec  {{parts.buildout.directory}}/bin/send -n -f "{}"  \;
find "$WORK_DIR" -maxdepth 1 -name "*@$START--$END*.csv" -exec rm "{}" \;
