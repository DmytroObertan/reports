#!/usr/bin/bash


BROKERS="{{ brokers }}"
WORK_DIR="{{parts.buildout.directory}}/var/reports"
BIN_DIR="{{parts.buildout.directory}}/bin"
BUCKET="{{ bucket }}"

parse_date () {

    IFS='-' read -r year month day< <(echo $1)
    if [ -z $year ] || [ -z $month ] || [ -z $day ]; then
        year=$(date +'%Y')
        if [ -z $month ] && [ -z $day ]; then
            month=$1
            day="01"
        fi
        if ! [ -z $month ] && [ -z $day ]; then
            IFS='-' read -r month day< <(echo $1)
        fi
    fi

    echo $(date -d"$year-$month-$day" +'%Y-%m-%d')
}

if [ -z "$1" ]; then
    START="$(date -d'-1 month' +'%Y-%m')-01"
else
    START=$(parse_date $1)
fi

if [ -z "$2" ]; then
    END="$(date  +'%Y-%m')-01"
else
    END=$(parse_date $2)
fi



echo "Generating reports form $START to $END"
echo

for broker in $BROKERS;do


    FILE_PATTERN="${WORK_DIR}/${broker}@$START--$END"
    for cmd in bids tenders invoices refunds; do
        echo "Generating ${cmd} for ${broker}"
        "${BIN_DIR}/${cmd}" -b "$broker" -p "$START" "$END"
    done

    for file in $(find $WORK_DIR  -maxdepth 1 -regex "$FILE_PATTERN-\(tenders\|refunds\).csv"); do
        mv "$file" "${file}_contracts.csv"
    done

    for status in cancelled unsuccessful; do

        for cmd in tenders refunds; do 
            "$BIN_DIR/$cmd" -b "$broker" -p "$START" "$END" --status one="$status"
        done

        for file in $(find $WORK_DIR  -maxdepth 1 -regex "$FILE_PATTERN-\(tenders\|refunds\).csv"); do
            mv "$file" "${file}_${status}.csv"
        done

    done


    passwd=$(pass {{ zip_path }}/$broker)
    echo "Creating zip file with bids and invoices for ${broker}"
    find "$WORK_DIR"  -maxdepth 1 -regex "$FILE_PATTERN-\(invoices\|bids\).csv"  | xargs -L 2 "${BIN_DIR}/zip" -p "$passwd" -z "$broker@$START--$END-bids-invoices.zip" -f 

done


echo "Creating zip archive with refunds"
find "$WORK_DIR" -maxdepth 1 -regex ".*@$START--$END-\(tenders\|refunds\).*.csv" | xargs "${BIN_DIR}/zip" -z "ALL@$START--$END-tender-refunds.zip" -f

echo "Sending to s3"
for file in find "$WORK_DIR" -maxdepth 1 -name "*@$START--$END*.zip" -exec basename {}  \; do
    s3cmd put "s3://$BUCKET/$file"
done
